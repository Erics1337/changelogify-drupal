<?php

/**
 * @file
 * Primary module hooks for Changelogify.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;
use Drupal\user\UserInterface;

/**
 * Implements hook_entity_insert().
 */
function changelogify_entity_insert(EntityInterface $entity): void {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
  $event_manager = \Drupal::service('changelogify.event_manager');

  $event_manager->logEvent([
    'event_type' => 'content_created',
    'source' => 'content_entity',
    'entity_type_id' => $entity->getEntityTypeId(),
    'entity_id' => (int) $entity->id(),
    'bundle' => $entity->bundle(),
    'message' => t('Created @type: "@title"', [
      '@type' => $entity->type->entity->label(),
      '@title' => $entity->getTitle(),
    ])->__toString(),
    'section_hint' => 'added',
    'metadata' => [
      'title' => $entity->getTitle(),
      'path' => $entity->toUrl()->toString(),
    ],
  ]);
}

/**
 * Implements hook_entity_update().
 */
function changelogify_entity_update(EntityInterface $entity): void {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
  $event_manager = \Drupal::service('changelogify.event_manager');

  $event_manager->logEvent([
    'event_type' => 'content_updated',
    'source' => 'content_entity',
    'entity_type_id' => $entity->getEntityTypeId(),
    'entity_id' => (int) $entity->id(),
    'bundle' => $entity->bundle(),
    'message' => t('Updated @type: "@title"', [
      '@type' => $entity->type->entity->label(),
      '@title' => $entity->getTitle(),
    ])->__toString(),
    'section_hint' => 'changed',
    'metadata' => [
      'title' => $entity->getTitle(),
      'path' => $entity->toUrl()->toString(),
    ],
  ]);
}

/**
 * Implements hook_entity_delete().
 */
function changelogify_entity_delete(EntityInterface $entity): void {
  if (!$entity instanceof NodeInterface) {
    return;
  }

  /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
  $event_manager = \Drupal::service('changelogify.event_manager');

  $event_manager->logEvent([
    'event_type' => 'content_deleted',
    'source' => 'content_entity',
    'entity_type_id' => $entity->getEntityTypeId(),
    'entity_id' => (int) $entity->id(),
    'bundle' => $entity->bundle(),
    'message' => t('Deleted @type: "@title"', [
      '@type' => $entity->type->entity->label(),
      '@title' => $entity->getTitle(),
    ])->__toString(),
    'section_hint' => 'removed',
    'metadata' => [
      'title' => $entity->getTitle(),
    ],
  ]);
}

/**
 * Implements hook_modules_installed().
 */
function changelogify_modules_installed(array $modules, bool $is_syncing): void {
  if ($is_syncing) {
    return;
  }

  /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
  $event_manager = \Drupal::service('changelogify.event_manager');

  foreach ($modules as $module) {
    // Skip logging our own installation.
    if ($module === 'changelogify') {
      continue;
    }

    $event_manager->logEvent([
      'event_type' => 'module_installed',
      'source' => 'system',
      'message' => t('Installed module: @module', ['@module' => $module])->__toString(),
      'section_hint' => 'added',
      'metadata' => [
        'module' => $module,
      ],
    ]);
  }
}

/**
 * Implements hook_modules_uninstalled().
 */
function changelogify_modules_uninstalled(array $modules, bool $is_syncing): void {
  if ($is_syncing) {
    return;
  }

  /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
  $event_manager = \Drupal::service('changelogify.event_manager');

  foreach ($modules as $module) {
    $event_manager->logEvent([
      'event_type' => 'module_uninstalled',
      'source' => 'system',
      'message' => t('Uninstalled module: @module', ['@module' => $module])->__toString(),
      'section_hint' => 'removed',
      'metadata' => [
        'module' => $module,
      ],
    ]);
  }
}

/**
 * Implements hook_user_insert().
 */
function changelogify_user_insert(UserInterface $account): void {
  /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
  $event_manager = \Drupal::service('changelogify.event_manager');

  $event_manager->logEvent([
    'event_type' => 'user_created',
    'source' => 'user',
    'entity_type_id' => 'user',
    'entity_id' => (int) $account->id(),
    'message' => t('Created user: @name', ['@name' => $account->getAccountName()])->__toString(),
    'section_hint' => 'added',
    'metadata' => [
      'username' => $account->getAccountName(),
    ],
  ]);
}

/**
 * Implements hook_user_update().
 */
function changelogify_user_update(UserInterface $account): void {
  /** @var \Drupal\Core\Entity\EntityInterface $original */
  $original = $account->original;

  // Check if roles changed.
  $old_roles = $original->getRoles();
  $new_roles = $account->getRoles();

  if ($old_roles !== $new_roles) {
    /** @var \Drupal\changelogify\EventManagerInterface $event_manager */
    $event_manager = \Drupal::service('changelogify.event_manager');

    $event_manager->logEvent([
      'event_type' => 'user_role_changed',
      'source' => 'user',
      'entity_type_id' => 'user',
      'entity_id' => (int) $account->id(),
      'message' => t('Changed roles for user: @name', ['@name' => $account->getAccountName()])->__toString(),
      'section_hint' => 'changed',
      'metadata' => [
        'username' => $account->getAccountName(),
        'old_roles' => $old_roles,
        'new_roles' => $new_roles,
      ],
    ]);
  }
}

/**
 * Implements hook_theme().
 */
function changelogify_theme(): array {
  return [
    'changelogify_release_list' => [
      'variables' => [
        'releases' => [],
      ],
    ],
    'changelogify_release' => [
      'variables' => [
        'release' => NULL,
        'sections' => [],
      ],
    ],
  ];
}
